# App Development TODOs

このドキュメントは、アプリの改善とApp Store申請に向けた残りのタスクをまとめたものです。
完了した項目はチェックボックスにチェックを入れてください。

## 🚀 フェーズ1: コードベースのリファクタリングと安定性向上

### 認証・データフローの安定化
- [ ] **認証の安定化 (最優先)**
    - [ ] `onAuthStateChange`リスナーを導入し、リフレッシュトークンを正しく管理し、常に最新のセッションを保存する。
    - [ ] `Invalid Refresh Token: Already Used`エラーが解消されたことを確認する。
- [x] **アプリ起動時の依存性注入の修正**
    - [x] `ios_watchme_v9App.swift`の`init()`における`StateObject`の初期化を修正し、依存関係が正しく注入されるようにする。
- [x] **初期データ取得トリガーの改善**
    - [x] 認証状態の変化に応じてデータが確実にロードされるようにする。
    - **NOTE:** `.task(id:)` ではなく、`UserAccountManager` 内で認証状態の変化をトリガーに、より堅牢な形で実装済み。
- [x] **ダッシュボードデータ表示の最終確認**
    - [x] ダッシュボードのデータが常に正しく表示され、デバイス切り替え時にも安定して動作することを確認する。
    - **NOTE:** データフローの基盤ロジックは実装済み。最終的な目視確認を残すのみ。

### パフォーマンス改善
- [ ] **初回フォーム入力時のフリーズ問題 (最優先)**
    - **現状:** アプリ内で初回に`TextField`（ログイン、新規登録画面など）をタップした際、約5〜7秒間UIが完全にフリーズする。
    - **原因:** `Supabase`の初期化が原因ではなく、SwiftUIの特定の条件下（`.sheet`内で`@FocusState`を利用した`TextField`）で、iOSのキーボードおよび予測変換システムが初めて初期化される際に発生する、既知のパフォーマンス問題である可能性が極めて高い。Xcodeのログにある `Hang detected` や `Received external candidate resultset` がこれを示唆している。
    - **対策:** ユーザーが「ログイン」や「はじめる」ボタンを押した直後に、中間的な「準備中...」画面を意図的に表示する。この画面の裏側で、非表示の`TextField`をプログラム的にフォーカス/非フォーカスさせることで、キーボードシステムを事前に初期化する。初期化完了後、自動的に目的のフォーム画面（ログイン/新規登録）に遷移させる。これにより、ユーザーが体感するフリーズをなくし、「処理中」という自然な待機時間に変える。

## 🍎 フェーズ2: App Store申請準備

### 法務・プライバシー関連
- [ ] **プライバシーポリシーの確定版作成 (最重要)**
    - [ ] アプリの現在のデータ取り扱い（特に音声データ：ユーザーが明示的に録音を開始した場合のみ、バックグラウンドでの継続録音は行わない）を正確に反映した、最終的かつ包括的なプライバシーポリシー文書を作成する。
    - [ ] データ利用、保存、保持期間、共有（AIサービスとの共有など）について詳細に記述する。
    - [ ] ユーザーの権利（データへのアクセス、削除）と問い合わせ先を明記する。
    - [ ] アプリ内にプライバシーポリシーへのアクセス可能なリンクを設置する。
- [ ] **利用規約の正式版作成**
    - [ ] 正式な利用規約文書を作成する。
    - [ ] アプリ内に利用規約へのアクセス可能なリンクを設置する。

### 審査対応
- [ ] **App Store審査ガイドラインへの準拠**
    - [ ] アバターアップローダーAPIのセキュリティ脆弱性（バックエンドでの認証有効化）を解消する。
    - [ ] 音声録音とAI分析に関する、明確で明示的なアプリ内同意フローを実装する。
    - [ ] アプリが医療的な診断や主張を行わないことを確認する。
    - [ ] アプリ全体の安定性とパフォーマンスを最終確認する。
- [ ] **App Store Connectメタデータ準備**
    - [ ] アプリ名、サブタイトル、説明文、キーワードを準備する。
    - [ ] アプリのスクリーンショットとプレビュービデオをデザイン・撮影する。
    - [ ] 適切なカテゴリと年齢制限を選択する。

## 💰 フェーズ3: ビジネスロジックとデータベース設計

### ユーザー管理・課金関連
- [ ] **サブスクリプションプランの設計**
    - [ ] 異なるサブスクリプションティア（例: 無料プラン、プレミアムプラン）を定義する。
    - [ ] 各ティアで利用可能な機能を明確にする。
- [ ] **ユーザー登録ステータスの定義**
    - [ ] ユーザーの様々な状態（例: `pending_email_verification` (メール認証待ち), `active_free` (アクティブな無料ユーザー), `active_premium` (アクティブなプレミアムユーザー), `inactive` (非アクティブ)）を定義する。
- [ ] **データベーススキーマの更新**
    - [ ] サブスクリプションプランとユーザーの状態をサポートするために、Supabaseのスキーマを更新する（例: `users`テーブルに`subscription_plan_id`や`status`カラムを追加）。
    - [ ] サブスクリプション管理やアプリ内課金に必要なテーブルを実装する。
- [ ] **アプリ内課金 (IAP) の実装 (該当する場合)**
    - [ ] プレミアムプランのためのアプリ内課金機能をStoreKitで実装する。

### データ管理
- [ ] **音声データ削除メカニズムの実装**
    - [ ] 主となる削除メカニズム（例: 処理サービスがS3から音声ファイルを削除）を実装する。
    - [ ] セーフティネットとして、定期的なバッチ削除メカニズムを実装する。

## 🔧 低優先度の技術的改善

### ローカルストレージの最適化
- [ ] **空の日付ディレクトリのクリーンアップ（低優先度）**
    - [ ] 録音ファイル削除時に、そのディレクトリが空になったら自動削除する機能を実装
    - [ ] アプリ起動時に空のディレクトリを検出して削除する処理を追加
    - [ ] 現状：録音→送信→ファイル削除の流れで、空の日付ディレクトリ（YYYY-MM-DD形式）が残り続ける
    - [ ] 影響：長期的にディレクトリが蓄積する（例：17個の空ディレクトリ）
    - [ ] 備考：アプリからの録音機能の使用頻度が低いため、優先度は低い
