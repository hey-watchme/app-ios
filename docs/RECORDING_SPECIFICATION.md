# 録音機能 仕様書

**最終更新**: 2025-10-18
**ステータス**: ✅ **リファクタリング完了・安定稼働**

---

## 🎯 概要

WatchMeアプリの録音機能は、30分間隔でユーザーの音声を録音し、AI分析用にクラウドへアップロードする中核機能です。

2025-10-18に**View-Store-Service**アーキテクチャへの全面的なリファクタリングとバグ修正を完了し、以前のバージョンで確認されていた以下の重要課題をすべて解決しました。

---

## ✅ 解決済みの課題 (2025-10-18対応)

### 1. アップロード処理の根本的なバグ

- **問題**: すべてのアップロードが`400 Bad Request`エラーで失敗していた。
- **原因**: `UploaderService`が`URLSession`のAPIを誤って使用し、不正な形式のリクエストを送信していた（二重ラップ問題）。
- **解決策**: `URLSession.shared.upload(for:from:)`メソッドを使用し、手動で作成した`Data`型のボディを直接送信するように修正。これにより、すべてのアップロードが正常に成功するようになった。

### 2. オーディオセッション初期化失敗時の不適切な動作

- **問題**: オーディオセッションの準備に失敗しても、録音処理が続行されてしまい、不安定な状態に陥っていた。
- **原因**: `RecordingStore`に、初期化失敗を検知しても後続処理を中断するガードロジックが欠けていた。
- **解決策**: `startRecording`メソッド内に、オーディオセッションの準備が完了しているかを確認するガード処理を追加。失敗した場合はエラーを表示し、録音処理を安全に中断するように修正。

### 3. 録音開始時の3〜8秒のフリーズ問題

- **問題**: 録音ボタンを押してからUIが反応するまで、最大8秒程度のフリーズが発生していた。
- **原因**: 録音ボタン押下時に、`AVAudioSession`の設定など、重い初期化処理が同期的に実行されていた。
- **解決策**: `RecordingView`の表示時（`.onAppear`）に、`RecordingStore`の`initialize`メソッドを呼び出し、オーディオセッションを事前に非同期で準備する方式に変更。ボタン押下時は軽量な処理のみ実行されるため、ユーザー体感遅延はゼロになった。

### 4. タイムゾーンのバグ（2025-10-18対応）

- **問題**: 録音データのタイムスタンプとタイムブロックが、デバイスのタイムゾーンではなくUTCで保存されていた。例：日本時間22:00の録音が、UTC 13:00（`time_block: 13-00`）として保存される。
- **原因**: `UploaderService.swift`の`createMultipartBody`メソッドで、`ISO8601DateFormatter()`がデフォルトでUTCに変換していたため、デバイスのタイムゾーン情報（`Asia/Tokyo`）が失われていた。
- **解決策**:
  1. `UploadRequest`構造体に`timezone: TimeZone`フィールドを追加
  2. `RecordingStore.createUploadRequest`でデバイスのタイムゾーン（`deviceManager.selectedDeviceTimezone`）を設定
  3. `UploaderService.createMultipartBody`で、`ISO8601DateFormatter`にデバイスのタイムゾーンを設定してフォーマット
- **結果**: `recorded_at`がデバイスのタイムゾーン情報を含む形式（例：`2025-10-17T22:12:12+09:00`）で送信され、API側で正しいタイムブロック（`22-00`）が生成されるようになった。

---

## 🏗️ 新アーキテクチャ：View-Store-Service

今回のリファクタリングで全面的に導入された、責務の分離と単一方向のデータフローを徹底した設計です。

### 設計原則

1.  **単一の信頼できる状態 (Single Source of Truth):** 録音機能に関する全ての状態は、`RecordingStore`内の単一の`State`構造体に集約され、状態の矛盾を設計上不可能にしています。
2.  **単一方向のデータフロー:** データの流れを「UI操作 → Storeのアクション呼び出し → Stateの更新 → UIの再描画」という一方向に限定し、予測可能な動作を保証します。
3.  **明確な責務分離:** 各コンポーネントは、単一の責務に特化しています。

### コンポーネントの役割

#### 1. View層 (`RecordingView.swift`) - 表示装置
- **責務:** UIの表示と、ユーザー操作の受付のみ。
- **役割:** `RecordingStore`から最新の`State`を受け取り、画面を忠実に描画します。ビジネスロジックは一切持ちません。

#### 2. Store層 (`RecordingStore.swift`) - 司令塔・頭脳
- **責務:** 状態管理とビジネスロジックのすべて。
- **役割:** 唯一の状態である`RecordingState`を保持・公開し、UIからの指示に基づき`Service`層を呼び出して、その結果に応じて`State`を更新します。

#### 3. Service層 (`AudioRecorderService.swift`, `UploaderService.swift`) - 実行部隊
- **責務:** 特定の技術的タスク（録音、アップロード）の実行。
- **役割:** `AVFoundation`やネットワーク通信など、具体的な処理に特化します。状態を持たず、`Store`や`View`の存在を知りません。

### このアーキテクチャの価値

この設計により、以前の「ツギハギ感」の根本原因であった「責務の混在」と「状態の分散」が解消され、バグが起きにくく、将来の変更にも強い、クリーンなコードベースが実現しました。

---

## 📈 最終的な成果指標

### コード品質の改善

| 項目 | Before | After |
|------|--------|-------|
| RecordingView.swift | 879行（UI+ロジック混在） | 501行（UI層のみ） |
| AudioRecorder.swift | 928行（複数責務） | → AudioRecorderService (295行) |
| 責務 | 混在・密結合 | 分離・疎結合 |
| テスタビリティ | 困難 | 容易（Store/Service層） |

### パフォーマンスと信頼性

| 項目 | Before | After |
|------|--------|-------|
| 録音開始遅延 | 3～8秒 | **即座（0秒）** |
| アップロード | 100%失敗 | **正常に成功** |
| エラーハンドリング | 不完全 | **堅牢** |

