# 録音機能 仕様書

**最終更新**: 2025-10-30
**ステータス**: ✅ **UI刷新完了・安定稼働**

---

## 🎯 概要

WatchMeアプリの録音機能は、30分間隔でユーザーの音声を録音し、AI分析用にクラウドへアップロードする中核機能です。

### 主要な改修履歴

- **2025-10-18**: View-Store-Serviceアーキテクチャへの全面リファクタリング完了
- **2025-10-30**: 全画面録音UI（`FullScreenRecordingView`）への刷新、音声ビジュアライザーの実装

---

## 🎨 現在のUI構成 (2025-10-30)

### FullScreenRecordingView.swift
全画面表示の録音インターフェース（ChatGPT音声モード風）

#### UI要素
| 要素 | 仕様 | 説明 |
|-----|------|------|
| 背景 | `Color.black.opacity(0.8)` | 半透明の黒背景 |
| ビジュアライザー | `BlobVisualizerView` | 音声に反応するBlob |
| 録音ボタン | 赤い円（64×64）+ 白いリング（80×80、lineWidth: 3.2） | 録音開始/停止 |
| 停止ボタン | 赤い角丸四角（32×32、cornerRadius: 6.4） | 録音中に表示 |
| 録音時間 | `font(.system(size: 48, weight: .light, design: .rounded))` | MM:SS形式 |
| 閉じるボタン | `xmark` アイコン（右上、24pt） | モーダルを閉じる |
| エラー表示 | `ErrorMessageView` | 赤背景のトーストバナー |

#### 状態管理
| コンポーネント | 役割 | データフロー |
|-------------|------|------------|
| `RecordingStore` | 録音状態管理 | View-Store-Serviceアーキテクチャ |
| `AudioMonitorService` | 音声レベルモニタリング | リアルタイムで`audioLevel`を更新 |
| `DeviceManager` | デバイス選択状態 | 録音前のデバイスチェック |
| `UserAccountManager` | 権限チェック | 書き込み権限の確認 |

#### アニメーション
| 要素 | エフェクト | 設定 |
|-----|----------|------|
| 録音ボタン | スケール変化 | 録音中: 0.9倍、待機中: 1.0倍 |
| アニメーション | `.spring(response: 0.3)` | バネアニメーション |

### BlobVisualizerView.swift
音声に反応する有機的なBlob形状ビジュアライザー

#### 基本仕様
| パラメータ | 値 | 説明 |
|----------|-----|------|
| サイズ | 160×160 | フレームサイズ |
| complexity | 8 | スパイクの数 |
| 頂点数 | 160 | `complexity * 20` で計算、滑らかさを確保 |
| phaseOffset | 4.1 | 位相オフセット（各Blobをずらす） |
| phase乗数 | 1.7 | `phase * 1.7` で回転速度を調整 |

#### アニメーション設定
| パラメータ | 値 | 説明 |
|----------|-----|------|
| タイマー間隔 | 0.016秒 | 約60FPS |
| phase増分 | 0.025 | 毎フレームごとの回転速度 |
| 回転方式 | 無限増加 | phaseを無限に増やし続ける（ワープなし） |

#### 音声反応パラメータ
| パラメータ | 計算式 | 待機時（audioLevel=0） | 最大時（audioLevel=1） |
|----------|--------|---------------------|---------------------|
| amplitude | `0.01 + audioLevel * 0.35` | 0.01（ほぼ円形） | 0.36（明確な変形） |
| radiusMultiplier | `1.0 + audioLevel * 0.22` | 1.0倍 | 1.22倍 |

#### スパイクのランダム性
```swift
spikeRandomFactor = 0.6 + sin(spikeIndex * 2.718 + phase * 0.05) * 0.4 + 0.4
// 範囲: 0.6〜1.4倍
// 各スパイクに擬似ランダムな振幅を付与、phaseと連動してゆっくり変化
```

#### 視覚エフェクト
| エフェクト | 設定値 | 説明 |
|----------|--------|------|
| グラデーション | `RadialGradient` | シアン→ブルー |
| 開始色 | `Color.cyan` | 中心色 |
| 終了色 | `Color.blue` | 外側色 |
| startRadius | 0 | グラデーション開始位置 |
| endRadius | 100 | グラデーション終了位置 |
| shadow | `color: .cyan.opacity(0.5), radius: 20` | シアンの光彩効果 |
| 中心アイコン | `waveform` | SF Symbol、サイズ50、weight: .light |

### AudioMonitorService.swift
録音とは独立した音声レベルモニタリング

#### 役割
- `AVAudioEngine`を使用してリアルタイムで音声レベルを取得
- 録音の有無に関わらず動作（ビジュアライザー専用）
- RMS計算で正規化された音声レベル（0.0〜1.0）を提供

#### 技術仕様
| パラメータ | 値 | 説明 |
|----------|-----|------|
| エンジン | `AVAudioEngine` | 音声入力エンジン |
| バッファサイズ | 1024 | サンプルバッファサイズ |
| オーディオセッション | `.record`, `.measurement` | カテゴリとモード |
| 音声レベル計算 | RMS (Root Mean Square) | 二乗平均平方根 |
| 正規化係数 | 10.0 | `rms * 10.0` で0.0〜1.0に正規化 |
| 出力範囲 | 0.0〜1.0 | `min(max(rms * 10.0, 0.0), 1.0)` |

#### ライフサイクル
| イベント | タイミング | 動作 |
|---------|----------|------|
| 開始 | `FullScreenRecordingView.onAppear` | `startMonitoring()` |
| 停止 | `FullScreenRecordingView.onDisappear` | `stopMonitoring()` |
| 更新頻度 | リアルタイム | バッファごと（約1024サンプル）|

---

## ✅ 解決済みの課題 (2025-10-18対応)

### 1. アップロード処理の根本的なバグ

- **問題**: すべてのアップロードが`400 Bad Request`エラーで失敗していた。
- **原因**: `UploaderService`が`URLSession`のAPIを誤って使用し、不正な形式のリクエストを送信していた（二重ラップ問題）。
- **解決策**: `URLSession.shared.upload(for:from:)`メソッドを使用し、手動で作成した`Data`型のボディを直接送信するように修正。これにより、すべてのアップロードが正常に成功するようになった。

### 2. オーディオセッション初期化失敗時の不適切な動作

- **問題**: オーディオセッションの準備に失敗しても、録音処理が続行されてしまい、不安定な状態に陥っていた。
- **原因**: `RecordingStore`に、初期化失敗を検知しても後続処理を中断するガードロジックが欠けていた。
- **解決策**: `startRecording`メソッド内に、オーディオセッションの準備が完了しているかを確認するガード処理を追加。失敗した場合はエラーを表示し、録音処理を安全に中断するように修正。

### 3. 録音開始時の3〜8秒のフリーズ問題

- **問題**: 録音ボタンを押してからUIが反応するまで、最大8秒程度のフリーズが発生していた。
- **原因**: 録音ボタン押下時に、`AVAudioSession`の設定など、重い初期化処理が同期的に実行されていた。
- **解決策**: `RecordingView`の表示時（`.onAppear`）に、`RecordingStore`の`initialize`メソッドを呼び出し、オーディオセッションを事前に非同期で準備する方式に変更。ボタン押下時は軽量な処理のみ実行されるため、ユーザー体感遅延はゼロになった。

### 4. タイムゾーンのバグ（2025-10-18対応）

- **問題**: 録音データのタイムスタンプとタイムブロックが、デバイスのタイムゾーンではなくUTCで保存されていた。例：日本時間22:00の録音が、UTC 13:00（`time_block: 13-00`）として保存される。
- **原因**: `UploaderService.swift`の`createMultipartBody`メソッドで、`ISO8601DateFormatter()`がデフォルトでUTCに変換していたため、デバイスのタイムゾーン情報（`Asia/Tokyo`）が失われていた。
- **解決策**:
  1. `UploadRequest`構造体に`timezone: TimeZone`フィールドを追加
  2. `RecordingStore.createUploadRequest`でデバイスのタイムゾーン（`deviceManager.selectedDeviceTimezone`）を設定
  3. `UploaderService.createMultipartBody`で、`ISO8601DateFormatter`にデバイスのタイムゾーンを設定してフォーマット
- **結果**: `recorded_at`がデバイスのタイムゾーン情報を含む形式（例：`2025-10-17T22:12:12+09:00`）で送信され、API側で正しいタイムブロック（`22-00`）が生成されるようになった。

---

## 🏗️ 新アーキテクチャ：View-Store-Service

今回のリファクタリングで全面的に導入された、責務の分離と単一方向のデータフローを徹底した設計です。

### 設計原則

1.  **単一の信頼できる状態 (Single Source of Truth):** 録音機能に関する全ての状態は、`RecordingStore`内の単一の`State`構造体に集約され、状態の矛盾を設計上不可能にしています。
2.  **単一方向のデータフロー:** データの流れを「UI操作 → Storeのアクション呼び出し → Stateの更新 → UIの再描画」という一方向に限定し、予測可能な動作を保証します。
3.  **明確な責務分離:** 各コンポーネントは、単一の責務に特化しています。

### コンポーネントの役割

#### 1. View層 (`FullScreenRecordingView.swift`) - 表示装置
- **責務:** UIの表示と、ユーザー操作の受付のみ。
- **役割:** `RecordingStore`から最新の`State`を受け取り、画面を忠実に描画します。ビジネスロジックは一切持ちません。
- **補助View:**
  - `BlobVisualizerView`: 音声ビジュアライザー
  - `RecordingButton`: 録音制御ボタン
  - `ErrorMessageView`: エラー表示

#### 2. Store層 (`RecordingStore.swift`) - 司令塔・頭脳
- **責務:** 状態管理とビジネスロジックのすべて。
- **役割:** 唯一の状態である`RecordingState`を保持・公開し、UIからの指示に基づき`Service`層を呼び出して、その結果に応じて`State`を更新します。

#### 3. Service層 (`AudioRecorderService.swift`, `UploaderService.swift`, `AudioMonitorService.swift`) - 実行部隊
- **責務:** 特定の技術的タスク（録音、アップロード、音声モニタリング）の実行。
- **役割:** `AVFoundation`やネットワーク通信など、具体的な処理に特化します。状態を持たず、`Store`や`View`の存在を知りません。
- **AudioMonitorService**: 録音とは独立して音声レベルをモニタリング（ビジュアライザー用）

### このアーキテクチャの価値

この設計により、以前の「ツギハギ感」の根本原因であった「責務の混在」と「状態の分散」が解消され、バグが起きにくく、将来の変更にも強い、クリーンなコードベースが実現しました。

---

## 📈 最終的な成果指標

### コード品質の改善

| 項目 | 旧実装 (2025-10-17以前) | リファクタリング後 (2025-10-18) | UI刷新後 (2025-10-30) |
|------|--------|-------|-------|
| View | RecordingView.swift (879行、混在) | RecordingView.swift (501行、UI層のみ) | FullScreenRecordingView.swift (236行、シンプル) |
| Recorder | AudioRecorder.swift (928行、複雑) | AudioRecorderService (295行) | 変更なし（既存Service使用） |
| ビジュアライザー | なし | なし | BlobVisualizerView (132行) + AudioMonitorService (99行) |
| 責務 | 混在・密結合 | 分離・疎結合 | 分離・疎結合（維持） |
| UX | 標準UI | 標準UI | 全画面・モダンUI |

### パフォーマンスと信頼性

| 項目 | Before | After |
|------|--------|-------|
| 録音開始遅延 | 3～8秒 | **即座（0秒）** |
| アップロード | 100%失敗 | **正常に成功** |
| エラーハンドリング | 不完全 | **堅牢** |

