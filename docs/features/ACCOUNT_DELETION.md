# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ã®å®Ÿè£…ä»•æ§˜

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€WatchMeã‚¢ãƒ—ãƒªã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ã®å®Ÿè£…ã«é–¢ã™ã‚‹ä»•æ§˜ã¨è¦ä»¶ã‚’å®šç¾©ã—ã¾ã™ã€‚

---

## ğŸ“‹ æ¦‚è¦

App Storeã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«æº–æ‹ ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã§ãã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### æ³•çš„è¦ä»¶
- **App Store Review Guidelines 5.1.1**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚’è¦æ±‚ã§ãã‚‹æ©Ÿèƒ½ã®æä¾›
- **GDPRï¼ˆEUä¸€èˆ¬ãƒ‡ãƒ¼ã‚¿ä¿è­·è¦å‰‡ï¼‰**: ãƒ‡ãƒ¼ã‚¿å‰Šé™¤æ¨©ï¼ˆRight to Erasureï¼‰
- **æ—¥æœ¬ã®å€‹äººæƒ…å ±ä¿è­·æ³•**: å€‹äººæƒ…å ±ã®æ¶ˆå»è«‹æ±‚

---

## ğŸ¯ å‰Šé™¤ã®ç¯„å›²

### 1. **å‰Šé™¤ã™ã¹ããƒ‡ãƒ¼ã‚¿**

#### âœ… å¿…é ˆå‰Šé™¤é …ç›®
- [ ] **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±**
  - `auth.users` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆSupabase Authï¼‰
  - `public.users` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
  - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥

- [ ] **éŸ³å£°ãƒ‡ãƒ¼ã‚¿**
  - S3ãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã•ã‚ŒãŸå…¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«
  - ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡: `recordings/{user_id}/{device_id}/{date}/{time}.wav`

- [ ] **ç”»åƒãƒ‡ãƒ¼ã‚¿**
  - S3ãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒã‚¿ãƒ¼ç”»åƒ
  - ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡: `avatars/users/{user_id}/avatar.jpg`

- [ ] **åˆ†æãƒ‡ãƒ¼ã‚¿**
  - `dashboard_summary` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
  - `emotion_reports` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  - `behavior_reports` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰

- [ ] **ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±**
  - `devices` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
  - APNsãƒ‡ãƒã‚¤ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³

- [ ] **ã‚³ãƒ¡ãƒ³ãƒˆãƒ»æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿**
  - `subject_comments` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
  - ãã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„

#### âš ï¸ å‰Šé™¤ã‚’æ¤œè¨ã™ã¹ãé …ç›®
- [ ] **é€šçŸ¥å±¥æ­´**
  - `notifications` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆå€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰

- [ ] **ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿**
  - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆå€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã¯å‰Šé™¤ï¼‰
  - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆå€‹äººæƒ…å ±ã¯åŒ¿ååŒ–ï¼‰

#### ğŸ”’ å‰Šé™¤ã—ãªã„ï¼ˆåŒ¿ååŒ–ã™ã‚‹ï¼‰é …ç›®
- [ ] **çµ±è¨ˆãƒ‡ãƒ¼ã‚¿**
  - å€‹äººã‚’ç‰¹å®šã§ããªã„å½¢å¼ã§é›†è¨ˆã•ã‚ŒãŸçµ±è¨ˆãƒ‡ãƒ¼ã‚¿
  - åŒ¿ååŒ–ã•ã‚ŒãŸåˆ†æçµæœï¼ˆç ”ç©¶ãƒ»æ”¹å–„ç›®çš„ï¼‰

---

## ğŸ› ï¸ å®Ÿè£…æ–¹é‡

### Phase 1: iOS ã‚¢ãƒ—ãƒªå´ã®å®Ÿè£…

#### 1. UIå®Ÿè£…
- âœ… `AccountSettingsView.swift` ã«ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆå®Œäº†ï¼‰
- [ ] å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®æ”¹å–„ï¼ˆ2æ®µéšç¢ºèªï¼‰
- [ ] å‰Šé™¤ç†ç”±ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†ï¼ˆä»»æ„ï¼‰

#### 2. å‰Šé™¤ãƒ•ãƒ­ãƒ¼
```swift
// æ¨å¥¨ãƒ•ãƒ­ãƒ¼
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã€ã‚’ã‚¿ãƒƒãƒ—
2. è­¦å‘Šãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼ˆ1å›ç›®ï¼‰
   - ã€Œå‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“ã€
3. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼ˆ2å›ç›®ï¼‰
   - ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã§ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã•ã›ã‚‹ï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰
4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã«å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
5. å‰Šé™¤å®Œäº†å¾Œã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
6. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»
```

#### 3. APIå‘¼ã³å‡ºã—
```swift
// NetworkManager.swift ã«è¿½åŠ 
func deleteAccount(userId: String) async throws {
    let url = URL(string: "\(baseURL)/user/delete")!
    var request = URLRequest(url: url)
    request.httpMethod = "DELETE"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")

    let body = ["user_id": userId]
    request.httpBody = try JSONEncoder().encode(body)

    let (data, response) = try await URLSession.shared.data(for: request)

    guard let httpResponse = response as? HTTPURLResponse,
          httpResponse.statusCode == 200 else {
        throw NetworkError.deleteFailed
    }
}
```

---

### Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã®å®Ÿè£…

#### 1. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
- [ ] `DELETE /user/delete` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ
- [ ] èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç¢ºèªï¼ˆå‰Šé™¤å¯¾è±¡ãŒæœ¬äººã‹ç¢ºèªï¼‰

#### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤é †åº

**é‡è¦**: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®é †åºã§å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```python
# æ¨å¥¨å‰Šé™¤é †åºï¼ˆä¾å­˜é–¢ä¿‚ã®é †ï¼‰
1. subject_comments (ã‚³ãƒ¡ãƒ³ãƒˆ)
2. notifications (é€šçŸ¥)
3. dashboard_summary (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰)
4. emotion_reports (æ„Ÿæƒ…åˆ†æ)
5. behavior_reports (è¡Œå‹•åˆ†æ)
6. devices (ãƒ‡ãƒã‚¤ã‚¹)
7. public.users (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«)
8. auth.users (èªè¨¼æƒ…å ±) â† Supabase Admin APIã‚’ä½¿ç”¨
```

**æ³¨æ„**: `ON DELETE CASCADE` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ã€æ˜ç¤ºçš„ãªå‰Šé™¤ä¸è¦ã€‚

#### 3. S3ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤

```python
import boto3

def delete_user_s3_files(user_id: str):
    s3_client = boto3.client('s3')
    bucket_name = 'your-bucket-name'

    # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
    recordings_prefix = f'recordings/{user_id}/'
    response = s3_client.list_objects_v2(Bucket=bucket_name, Prefix=recordings_prefix)

    if 'Contents' in response:
        objects_to_delete = [{'Key': obj['Key']} for obj in response['Contents']]
        s3_client.delete_objects(
            Bucket=bucket_name,
            Delete={'Objects': objects_to_delete}
        )

    # ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®å‰Šé™¤
    avatar_key = f'avatars/users/{user_id}/avatar.jpg'
    s3_client.delete_object(Bucket=bucket_name, Key=avatar_key)
```

#### 4. Supabase Auth ã®å‰Šé™¤

```python
from supabase import create_client, Client

def delete_supabase_auth_user(user_id: str):
    # Service Roleã‚­ãƒ¼ã‚’ä½¿ç”¨ï¼ˆç®¡ç†è€…æ¨©é™ï¼‰
    supabase: Client = create_client(
        supabase_url="https://your-project.supabase.co",
        supabase_key="your-service-role-key"
    )

    # auth.usersã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
    supabase.auth.admin.delete_user(user_id)
```

---

### Phase 3: ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®æ¤œè¨¼

#### å‰Šé™¤ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚ŒãŸã‹ç¢ºèª
- [ ] S3ãƒã‚±ãƒƒãƒˆã‹ã‚‰å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚ŒãŸã‹ç¢ºèª
- [ ] Supabase Authã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã•ã‚ŒãŸã‹ç¢ºèª
- [ ] å‰Šé™¤å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã“ã¨ã‚’ç¢ºèª
- [ ] å‰Šé™¤å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã§ããªã„ã“ã¨ã‚’ç¢ºèª

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

### 1. èªè¨¼ãƒ»èªå¯
- [ ] å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å®Ÿè¡Œå¯èƒ½
- [ ] å‰Šé™¤å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã¯å‰Šé™¤ä¸å¯

### 2. ãƒ­ã‚°è¨˜éŒ²
- [ ] å‰Šé™¤å®Ÿè¡Œã®ãƒ­ã‚°ã‚’è¨˜éŒ²ï¼ˆç›£æŸ»è¨¼è·¡ï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  - å‰Šé™¤å®Ÿè¡Œæ—¥æ™‚
  - å‰Šé™¤ç†ç”±ï¼ˆä»»æ„ï¼‰
  - å‰Šé™¤æˆåŠŸ/å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
- [ ] éƒ¨åˆ†çš„ã«å‰Šé™¤ãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ã‚¨ãƒ©ãƒ¼é€šçŸ¥

---

## ğŸ“§ å‰Šé™¤å¾Œã®é€šçŸ¥

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«
å‰Šé™¤å®Œäº†å¾Œã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ï¼š

```
ä»¶å: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®ãŠçŸ¥ã‚‰ã›

ãŠå®¢æ§˜ã®WatchMeã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚

å‰Šé™¤æ—¥æ™‚: 2025-10-18 14:30 JST
å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±
- éŸ³å£°éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿
- åˆ†æçµæœ
- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±

ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

â€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€privacy@watchme.app ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚
```

---

## ğŸ• å‰Šé™¤ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨çŒ¶äºˆæœŸé–“

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: å³æ™‚å‰Šé™¤ï¼ˆå³æ ¼ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹ã¨å³åº§ã«å‰Šé™¤
- å¾©å…ƒä¸å¯èƒ½

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: çŒ¶äºˆæœŸé–“ä»˜ãå‰Šé™¤ï¼ˆæ¨å¥¨ï¼‰
- å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¾Œã€30æ—¥é–“ã®çŒ¶äºˆæœŸé–“
- çŒ¶äºˆæœŸé–“ä¸­ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸å¯ï¼‰
- æœŸé–“ä¸­ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½
- 30æ—¥å¾Œã«è‡ªå‹•çš„ã«å®Œå…¨å‰Šé™¤

**æ¨å¥¨**: ã‚ªãƒ—ã‚·ãƒ§ãƒ³2ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ï¼‰

---

## ğŸ“Š å‰Šé™¤çµ±è¨ˆã®è¨˜éŒ²ï¼ˆåŒ¿ååŒ–ï¼‰

å‰Šé™¤ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®çµ±è¨ˆæƒ…å ±ã‚’åŒ¿ååŒ–ã—ã¦è¨˜éŒ²ï¼š

```sql
CREATE TABLE account_deletions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    deleted_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    account_age_days INTEGER, -- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‹ã‚‰å‰Šé™¤ã¾ã§ã®æ—¥æ•°
    deletion_reason TEXT, -- å‰Šé™¤ç†ç”±ï¼ˆä»»æ„ï¼‰
    total_recordings INTEGER, -- å‰Šé™¤ã•ã‚ŒãŸéŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«æ•°
    user_id_hash TEXT -- ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¾©å…ƒä¸å¯èƒ½ï¼‰
);
```

**æ³¨æ„**: å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã¯ä¸€åˆ‡ä¿å­˜ã—ãªã„

---

## ğŸš€ å®Ÿè£…å„ªå…ˆåº¦

### ğŸ”´ Phase 1: å®Œå…¨å‰Šé™¤ï¼ˆApp Storeå¯©æŸ»å¿…é ˆï¼‰
1. âœ… iOS ã‚¢ãƒ—ãƒªUIã®å®Ÿè£…ï¼ˆå®Œäº†ï¼‰
2. [ ] **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç¢ºèªãƒ»ä½œæˆ**

   **ç¢ºèªæ¸ˆã¿ï¼ˆâœ… æ—¢å­˜ï¼‰**:
   - `users(user_id)` - UNIQUE INDEX
   - `notifications(user_id)`
   - `user_devices(user_id)`
   - `subjects(created_by_user_id)`
   - `subject_comments(user_id)`
   - `notification_reads(user_id)`

   **âœ… è¿½åŠ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦**:
   ```sql
   -- dashboard_summary ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒç¢ºèªçµæœï¼š
   -- âŒ user_id ã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ãªã„
   -- âŒ subject_id ã‚«ãƒ©ãƒ ã‚‚å­˜åœ¨ã—ãªã„
   -- âœ… PRIMARY KEY (device_id, date) ãŒå­˜åœ¨

   -- å‰Šé™¤æ–¹æ³•ï¼š
   -- 1. user_devices ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ device_id ã‚’å–å¾—
   -- 2. device_id ã§ dashboard_summary ã‚’å‰Šé™¤ï¼ˆæ—¢å­˜ã® PRIMARY KEY ã§é«˜é€Ÿï¼‰
   ```

   **æ³¨æ„**: `dashboard_summary` ã«ã¯ `user_id` ãŒç›´æ¥å­˜åœ¨ã—ãªã„ãŸã‚ã€`user_devices` ãƒ†ãƒ¼ãƒ–ãƒ«çµŒç”±ã§ãƒ‡ãƒã‚¤ã‚¹IDã‚’å–å¾—ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚æ—¢å­˜ã®PRIMARY KEYã§ååˆ†é«˜é€ŸãªãŸã‚ã€è¿½åŠ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä¸è¦ã§ã™ã€‚
3. [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API `/user/delete` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
4. [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤å®Ÿè£…
5. [ ] **S3ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨å‰Šé™¤å®Ÿè£…**
   - éŸ³å£°ãƒ‡ãƒ¼ã‚¿ï¼ˆwav/mp3ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
   - ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ
   - ãã®ä»–ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
6. [ ] Supabase Authå‰Šé™¤å®Ÿè£…

**æ–¹é‡**: Phase 1ã§ã¯**ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤**ï¼ˆæœ€ã‚‚å®‰å…¨ãªæ–¹æ³•ï¼‰

### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆUXå‘ä¸Šï¼‰
7. [ ] å‰Šé™¤ç¢ºèªãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡
8. [ ] å‰Šé™¤ç†ç”±ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
9. [ ] 2æ®µéšç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å®Ÿè£…

### ğŸŸ¢ Phase 2: æ©Ÿæ¢°å­¦ç¿’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ï¼ˆå°†æ¥å¯¾å¿œï¼‰
10. [ ] çŒ¶äºˆæœŸé–“ä»˜ãå‰Šé™¤ã®å®Ÿè£…
11. [ ] å‰Šé™¤çµ±è¨ˆã®è¨˜éŒ²
12. [ ] **æ©Ÿæ¢°å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ä¿æŒã®æ³•çš„æ•´å‚™**ï¼ˆä¸‹è¨˜ã€ŒPhase 2ã®è©³ç´°ã€å‚ç…§ï¼‰

---

## ğŸ”¬ Phase 2: æ©Ÿæ¢°å­¦ç¿’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã®è¨­è¨ˆï¼ˆå°†æ¥å¯¾å¿œï¼‰

### ç›®çš„
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

### èª²é¡Œèªè­˜
- âŒ éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãã®ã‚‚ã® â†’ å€‹äººæƒ…å ±ï¼ˆå‰Šé™¤å¿…é ˆï¼‰
- âŒ ç™ºè©±å†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ â†’ å€‹äººæƒ…å ±ï¼ˆå‰Šé™¤å¿…é ˆï¼‰
- â“ éŸ³éŸ¿çš„ç‰¹å¾´ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰ â†’ ãƒ©ãƒ™ãƒ«ãªã—ã§ã¯ç„¡æ„å‘³
- âœ… ãƒ©ãƒ™ãƒ«ä»˜ãéŸ³éŸ¿ç‰¹å¾´ â†’ æ©Ÿæ¢°å­¦ç¿’ã«æœ‰ç”¨ï¼ˆãŸã ã—æ³•çš„æ•´å‚™ãŒå¿…è¦ï¼‰

### æ¤œè¨ã™ã¹ãä¿æŒãƒ‡ãƒ¼ã‚¿

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: éŸ³éŸ¿ç‰¹å¾´é‡ã®ã¿ï¼ˆåŒ¿ååŒ–ï¼‰
```python
# ä¿æŒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ä¾‹
{
    "feature_id": "uuid",  # ãƒ©ãƒ³ãƒ€ãƒ IDï¼ˆuser_idå‰Šé™¤ï¼‰
    "acoustic_features": [
        {"mfcc": [0.1, 0.2, ...], "pitch": 120, "energy": 0.8},
        # éŸ³éŸ¿çš„ç‰¹å¾´ã®ã¿
    ],
    "emotion_label": "happy",  # AIãŒæ¨è«–ã—ãŸæ„Ÿæƒ…ãƒ©ãƒ™ãƒ«
    "timestamp": "2025-10",  # æœˆå˜ä½ï¼ˆæ—¥æ™‚ã¯æ›–æ˜§åŒ–ï¼‰
}
```

**å•é¡Œç‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒãªã„ãŸã‚ã€åŒä¸€äººç‰©ã®æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ãˆãªã„ â†’ å­¦ç¿’åŠ¹æœãŒé™å®šçš„

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: ä»®ååŒ–IDä»˜ãéŸ³éŸ¿ç‰¹å¾´ï¼ˆæ¨å¥¨æ¤œè¨æ¡ˆï¼‰
```python
{
    "anonymous_user_id": "hash(user_id + salt)",  # å…ƒã«æˆ»ã›ãªã„ä»®ååŒ–ID
    "acoustic_features": [...],
    "emotion_label": "happy",
    "behavioral_context": "conversation",  # è¡Œå‹•ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    "timestamp": "2025-10",
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å­¦ç¿’å¯èƒ½
- å…ƒã®user_idã«ã¯æˆ»ã›ãªã„ï¼ˆä»®ååŒ–ï¼‰
- éŸ³å£°ãƒ‡ãƒ¼ã‚¿è‡ªä½“ã¯å‰Šé™¤æ¸ˆã¿

**æ³•çš„è¦ä»¶**:
- æ˜ç¢ºãªåŒæ„å–å¾—ãŒå¿…è¦
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®æ˜è¨˜
- ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨ç›®çš„ã®é€æ˜æ€§

### å¿…è¦ãªæ³•çš„å¯¾å¿œ

#### 1. åŒæ„å–å¾—ãƒ•ãƒ­ãƒ¼

**ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚**:
```
â˜‘ ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ã®ãŸã‚ã®åŒ¿ååŒ–ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨ã«åŒæ„ã—ã¾ã™ï¼ˆä»»æ„ï¼‰

ã€è©³ç´°ã€‘
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å¾Œã‚‚ã€ä»¥ä¸‹ã®æ¡ä»¶ã§åŒ¿ååŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¾ã™ï¼š
ãƒ»éŸ³éŸ¿çš„ç‰¹å¾´é‡ã®ã¿ä¿æŒï¼ˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ç™ºè©±å†…å®¹ã¯å‰Šé™¤ï¼‰
ãƒ»å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã¯å®Œå…¨å‰Šé™¤
ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ãƒ»æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®å‘ä¸Šã®ã¿ã«ä½¿ç”¨
ãƒ»ç¬¬ä¸‰è€…ã¸ã®æä¾›ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“

â€»ã“ã®åŒæ„ã¯ã„ã¤ã§ã‚‚æ’¤å›ã§ãã€æ’¤å›å¾Œã¯ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™
```

#### 2. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®è¿½è¨˜

```markdown
### æ©Ÿæ¢°å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒï¼ˆä»»æ„ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ„ãŒã‚ã‚‹å ´åˆã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å¾Œã‚‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒ¿ååŒ–ã—ã¦ä¿æŒã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼š

ã€ä¿æŒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€‘
- éŸ³éŸ¿çš„ç‰¹å¾´é‡ï¼ˆMFCCã€ãƒ”ãƒƒãƒã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ç­‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰
- æ„Ÿæƒ…ãƒ»è¡Œå‹•ã®åˆ†æçµæœãƒ©ãƒ™ãƒ«
- åŒ¿ååŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼‰

ã€ä¿æŒã—ãªã„ãƒ‡ãƒ¼ã‚¿ã€‘
- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãã®ã‚‚ã®
- ç™ºè©±å†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€æ°åç­‰ã®å€‹äººæƒ…å ±

ã€åˆ©ç”¨ç›®çš„ã€‘
ã‚µãƒ¼ãƒ“ã‚¹ã®ç²¾åº¦å‘ä¸ŠãŠã‚ˆã³æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®æ”¹å–„

ã€åŒæ„ã®æ’¤å›ã€‘
ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã‹ã‚‰ã€ã„ã¤ã§ã‚‚åŒæ„ã‚’æ’¤å›ã—ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚
```

### å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
```sql
-- åŒ¿ååŒ–ã•ã‚ŒãŸå­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿
CREATE TABLE ml_training_data (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    anonymous_user_id TEXT NOT NULL,  -- hash(user_id + salt)
    acoustic_features JSONB NOT NULL,
    emotion_label TEXT,
    behavioral_label TEXT,
    created_month DATE NOT NULL,  -- æœˆå˜ä½ï¼ˆæ—¥æ™‚ã¯ä¿å­˜ã—ãªã„ï¼‰
    consent_given_at TIMESTAMP WITH TIME ZONE NOT NULL,
    INDEX idx_anonymous_user_id (anonymous_user_id)
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ„çŠ¶æ…‹ç®¡ç†
CREATE TABLE ml_consent (
    user_id UUID PRIMARY KEY REFERENCES public.users(user_id) ON DELETE CASCADE,
    consent_given BOOLEAN DEFAULT FALSE,
    consent_date TIMESTAMP WITH TIME ZONE,
    revoked_date TIMESTAMP WITH TIME ZONE
);
```

#### å‰Šé™¤æ™‚ã®å‡¦ç†ï¼ˆå®Œå…¨ç‰ˆï¼‰
```python
@app.delete("/user/delete")
async def delete_user_account(user_id: str):
    # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒ‡ãƒã‚¤ã‚¹IDã‚’å–å¾—
    devices = supabase.table('user_devices') \
        .select('device_id') \
        .eq('user_id', user_id) \
        .execute()

    device_ids = [d['device_id'] for d in devices.data]

    # 2. dashboard_summary ã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒã‚¤ã‚¹ã”ã¨ï¼‰
    for device_id in device_ids:
        supabase.table('dashboard_summary') \
            .delete() \
            .eq('device_id', device_id) \
            .execute()

    # 3. subject_comments ã‚’å‰Šé™¤
    supabase.table('subject_comments') \
        .delete() \
        .eq('user_id', user_id) \
        .execute()

    # 4. notifications ã‚’å‰Šé™¤
    supabase.table('notifications') \
        .delete() \
        .eq('user_id', user_id) \
        .execute()

    # 5. subjects ã‚’å‰Šé™¤
    supabase.table('subjects') \
        .delete() \
        .eq('created_by_user_id', user_id) \
        .execute()

    # 6. user_devices ã‚’å‰Šé™¤
    supabase.table('user_devices') \
        .delete() \
        .eq('user_id', user_id) \
        .execute()

    # 7. S3ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    delete_s3_files(user_id)

    # 8. public.users ã‚’å‰Šé™¤
    supabase.table('users') \
        .delete() \
        .eq('user_id', user_id) \
        .execute()

    # 9. auth.users ã‚’å‰Šé™¤ï¼ˆService Roleå¿…è¦ï¼‰
    supabase.auth.admin.delete_user(user_id)

    return {"message": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ"}

def delete_s3_files(user_id: str):
    """S3ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"""
    s3_client = boto3.client('s3')
    bucket = 'your-bucket-name'

    # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    recordings_prefix = f'recordings/{user_id}/'
    response = s3_client.list_objects_v2(Bucket=bucket, Prefix=recordings_prefix)
    if 'Contents' in response:
        objects = [{'Key': obj['Key']} for obj in response['Contents']]
        s3_client.delete_objects(Bucket=bucket, Delete={'Objects': objects})

    # ã‚¢ãƒã‚¿ãƒ¼ç”»åƒå‰Šé™¤
    avatar_key = f'avatars/users/{user_id}/avatar.jpg'
    s3_client.delete_object(Bucket=bucket, Key=avatar_key)
```

### Phase 2å®Ÿè£…ã®å‰ææ¡ä»¶
- [ ] æ³•å‹™å°‚é–€å®¶ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®æ›´æ–°
- [ ] åŒæ„å–å¾—ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…
- [ ] ãƒ‡ãƒ¼ã‚¿åŒ¿ååŒ–å‡¦ç†ã®å®Ÿè£…
- [ ] åŒæ„æ’¤å›æ©Ÿèƒ½ã®å®Ÿè£…

---

## ğŸ“ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼](https://hey-watch.me/privacy) - ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“ã®è¨˜è¼‰
- [App Store Review Guidelines 5.1.1](https://developer.apple.com/app-store/review/guidelines/#data-collection-and-storage)
- [GDPR Article 17 - Right to Erasure](https://gdpr-info.eu/art-17-gdpr/)

---

## ğŸ”„ å®Ÿè£…çŠ¶æ³

### âœ… Phase 1-Aï¼ˆå®Ÿè£…å®Œäº† - 2025-10-19ï¼‰

**ç®¡ç†ç”»é¢APIçµŒç”±ã§ã®å‰Šé™¤æ©Ÿèƒ½**

1. âœ… **ç®¡ç†ç”»é¢APIå®Ÿè£…æ¸ˆã¿**
   - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `DELETE https://admin.hey-watch.me/api/users/{user_id}`
   - å‰Šé™¤å¯¾è±¡:
     - `user_devices` ãƒ†ãƒ¼ãƒ–ãƒ«
     - `auth.users` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSupabase Admin APIä½¿ç”¨ï¼‰
     - `public.users` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆON DELETE CASCADEï¼‰

2. âœ… **iOSã‚¢ãƒ—ãƒªçµ±åˆå®Œäº†**
   - `NetworkManager.swift`: `deleteAccount(userId:)` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ï¼ˆ655-689è¡Œç›®ï¼‰
   - `AccountSettingsView.swift`: å‰Šé™¤ãƒ•ãƒ­ãƒ¼å®Ÿè£…ï¼ˆ196-229è¡Œç›®ï¼‰
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: NetworkManagerã‚’é…å»¶åˆæœŸåŒ–ï¼ˆå‰Šé™¤æ™‚ã®ã¿ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ï¼‰
   - å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ: æˆåŠŸ
   - ãƒ“ãƒ«ãƒ‰æ¤œè¨¼: æˆåŠŸ

3. âœ… **éŸ³å£°ãƒ‡ãƒ¼ã‚¿è‡ªå‹•å‰Šé™¤**
   - Janitor APIã«ã‚ˆã‚Š6æ™‚é–“ã”ã¨ã«è‡ªå‹•å‰Šé™¤
   - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ™‚ã®æ‰‹å‹•å‰Šé™¤ã¯**ä¸è¦**

### ğŸš§ Phase 1-Bï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ï¼‰

**ç®¡ç†ç”»é¢APIã®æ‹¡å¼µ**

1. [ ] **é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤**
   - `notifications` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€šçŸ¥ã‚’å‰Šé™¤
   - å®Ÿè£…å ´æ‰€: `/Users/kaya.matsumoto/projects/watchme/admin/main.py`

2. [ ] **S3ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®å‰Šé™¤**
   - `avatars/users/{user_id}/avatar.jpg` ã‚’å‰Šé™¤
   - boto3ã‚’ä½¿ç”¨ï¼ˆrequirements.txtã«è¿½åŠ æ¸ˆã¿ï¼‰
   - å®Ÿè£…å ´æ‰€: `/Users/kaya.matsumoto/projects/watchme/admin/main.py`

3. [ ] **é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤**
   - `dashboard_summary` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆdevice_idçµŒç”±ï¼‰
   - `subject_comments` ãƒ†ãƒ¼ãƒ–ãƒ«
   - `subjects` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆcreated_by_user_idï¼‰

4. [ ] **æœ¬ç•ªç’°å¢ƒã¸ã®åæ˜ **
   - GitHub Actionsã§CI/CDè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ï¼‰
   - mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹

### ğŸ“ Phase 1-B å®Ÿè£…ä¾‹

```python
# /Users/kaya.matsumoto/projects/watchme/admin/main.py

@app.delete("/api/users/{user_id}")
async def delete_user(user_id: str):
    try:
        # 1. ãƒ‡ãƒã‚¤ã‚¹IDå–å¾—
        devices = await supabase_client.select('user_devices', filters={'user_id': user_id})
        device_ids = [d['device_id'] for d in devices]

        # 2. dashboard_summaryå‰Šé™¤ï¼ˆãƒ‡ãƒã‚¤ã‚¹ã”ã¨ï¼‰
        for device_id in device_ids:
            await supabase_client.delete('dashboard_summary', {'device_id': device_id})

        # 3. subject_commentså‰Šé™¤
        await supabase_client.delete('subject_comments', {'user_id': user_id})

        # 4. notificationså‰Šé™¤
        await supabase_client.delete('notifications', {'user_id': user_id})

        # 5. subjectså‰Šé™¤
        await supabase_client.delete('subjects', {'created_by_user_id': user_id})

        # 6. S3ã‚¢ãƒã‚¿ãƒ¼ç”»åƒå‰Šé™¤
        delete_avatar_image(user_id)

        # 7. user_deviceså‰Šé™¤ï¼ˆæ—¢å­˜ï¼‰
        await supabase_client.delete('user_devices', {'user_id': user_id})

        # 8. auth.userså‰Šé™¤ï¼ˆæ—¢å­˜ï¼‰
        await supabase_client.delete_auth_user(user_id)

        return {"success": True, "message": "å®Œå…¨å‰Šé™¤ã—ã¾ã—ãŸ"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

def delete_avatar_image(user_id: str):
    """S3ã‹ã‚‰ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’å‰Šé™¤"""
    import boto3
    import os

    s3_client = boto3.client('s3')
    bucket = os.getenv('S3_BUCKET_NAME')  # ç’°å¢ƒå¤‰æ•°ã«è¿½åŠ å¿…è¦
    avatar_key = f'avatars/users/{user_id}/avatar.jpg'

    try:
        s3_client.delete_object(Bucket=bucket, Key=avatar_key)
        print(f"âœ… S3ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤: {avatar_key}")
    except Exception as e:
        print(f"âš ï¸ S3ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼ˆå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ï¼‰: {e}")
```

### ğŸŸ¢ Phase 2ï¼ˆå°†æ¥å¯¾å¿œï¼‰

1. [ ] æ³•å‹™å°‚é–€å®¶ã«ã‚ˆã‚‹æ©Ÿæ¢°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä¿æŒã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. [ ] ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®æ›´æ–°
3. [ ] åŒæ„å–å¾—ãƒ•ãƒ­ãƒ¼ã®è¨­è¨ˆãƒ»å®Ÿè£…
4. [ ] éŸ³éŸ¿ç‰¹å¾´é‡æŠ½å‡ºãƒ»åŒ¿ååŒ–å‡¦ç†ã®å®Ÿè£…
5. [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã®æ§‹ç¯‰

---

## ğŸ“Œ é‡è¦ãªè£œè¶³æƒ…å ±

### éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦
- âŒ **æ‰‹å‹•å‰Šé™¤ã¯ä¸è¦**: Janitor APIãŒ6æ™‚é–“ã”ã¨ã«è‡ªå‹•å‰Šé™¤
- âœ… **ä¿å­˜æœŸé–“**: åˆ†æå®Œäº†å¾Œã€æœ€é•·24æ™‚é–“ä»¥å†…
- âœ… **å‰Šé™¤æ¡ä»¶**: æ–‡å­—èµ·ã“ã—ãƒ»è¡Œå‹•åˆ†æãƒ»æ„Ÿæƒ…åˆ†æãŒã™ã¹ã¦å®Œäº†

### S3ãƒã‚±ãƒƒãƒˆåã®ç’°å¢ƒå¤‰æ•°
ç®¡ç†ç”»é¢ã®`.env`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:
```bash
S3_BUCKET_NAME=watchme-vault
AWS_REGION=ap-southeast-2
```

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-10-19
**æ‹…å½“è€…**: é–‹ç™ºãƒãƒ¼ãƒ 
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 1-Aå®Œäº† / Phase 1-Bæ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Š / Phase 2æ¤œè¨ä¸­
**ãƒªãƒªãƒ¼ã‚¹æ–¹é‡**: Phase 1-Aï¼ˆåŸºæœ¬å‰Šé™¤ï¼‰ã§å¯©æŸ»ç”³è«‹å¯èƒ½ â†’ Phase 1-Bï¼ˆå®Œå…¨å‰Šé™¤ï¼‰ã§ãƒªãƒªãƒ¼ã‚¹ â†’ Phase 2ã¯å°†æ¥å®Ÿè£…
