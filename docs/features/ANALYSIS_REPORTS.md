# 分析レポート機能

最終更新: 2025-12-01

## 📋 概要

WatchMeアプリでは、録音データから生成された分析結果を複数のレベルで表示・管理する機能を提供しています。ユーザーは日次・週次・月次の各レベルで自分のデータを振り返ることができます。

---

## 🎯 分析レベル

WatchMeでは、4つの分析レベルでデータを表示します：

| 分析レベル | 単位 | 説明 |
|----------|------|------|
| **Spot分析** | 録音1件 | 録音ごとの即時分析結果 |
| **Daily分析** | 1日 | 1日単位の累積分析 |
| **Weekly分析** | 1週間 | 1週間単位の総括分析 |
| **Monthly分析** | 1ヶ月 | 1ヶ月単位の総括分析 |

---

## 📱 レポート画面の構成

### レポートタブ

レポート画面では、日次・週次・月次の3つのタブでデータを切り替えて表示できます。

```
┌─────────────────────────────────────┐
│ 📊 レポート                          │
├─────────────────────────────────────┤
│ [日次] [週次] [月次]  ← タブ切り替え │
│  ^^^^                               │
│  デフォルト選択                      │
└─────────────────────────────────────┘
```

---

## 1️⃣ 日次レポート（Daily Report）

### 概要

日次レポートでは、過去の日ごとの気分スコア（vibe_score）の推移をグラフと一覧で確認できます。

### 期間選択

以下の期間を選択できます：
- **過去7日間**（デフォルト）
- **過去30日間**
- **過去90日間**

### 表示内容

#### 📈 気分の推移グラフ

- **横軸**: 日付（期間に応じて7日/30日/90日分）
- **縦軸**: 気分スコア（-50 〜 +50）
- **中心線（0）**: 基準線
- **棒グラフ**:
  - ポジティブスコア（緑）: 0から上に伸びる
  - ネガティブスコア（赤）: 0から下に伸びる
  - データなし（グレー）: 中心線に短い線で表示

**データ欠損の視覚化**:
- データがない日は**グレーの短い線**で表示され、時間軸の位置は保持されます
- これにより、選択した期間全体のスケールが一目でわかります

#### 📋 日次サマリー一覧

各日のカードに以下を表示：
- **日付**: M/d (E) 形式
- **気分スコア**: 数値と色分け
- **サマリー**: その日の要約（最大2行）
- **詳細ボタン**: タップで詳細ページへ

**データがない日**:
- 薄いグレー背景
- 「データなし」と表示
- 「この日のデータは記録されていません」というメッセージ
- 詳細ボタンは非表示

---

## 🔍 詳細ページ

### Daily詳細ページ（DailyDetailView）

日次サマリー一覧の「詳細を見る」をタップすると表示されます。

#### 表示内容

1. **日付ヘッダー**: yyyy年M月d日 (E) 形式
2. **日次平均スコア**: vibe_scoreを大きく表示
3. **日次サマリー**: summaryフィールドの全文
4. **気分スコアタイムライン**: vibe_scores配列のグラフ（30分刻み）
5. **感情変化イベント**: burst_events一覧
6. **その日のSpot一覧**: 録音ごとのカード（タップでSpot詳細へ）

---

### Spot詳細ページ（SpotDetailView）

録音1件の詳細を表示します。

#### 表示内容

1. **録音時刻**: 日付と時刻
2. **Vibe Score**: その録音のスコア
3. **Summary**: 録音内容のサマリー
4. **Behavior**: 検出された行動
5. **Transcription**: 文字起こし（利用可能な場合）

---

## 2️⃣ 週次レポート（Weekly Report）

### 概要

週次レポートでは、週ごとに生成された総括を表示します。

### 表示内容

#### 週次一覧

各週のカードに以下を表示：
- **期間**: M月第N週（M/d〜M/d）
- **週の総括**: summaryフィールドの要約
- **印象的イベント件数**: memorable_eventsの件数
- **詳細ボタン**: タップで詳細ページへ

---

### Weekly詳細ページ（WeeklyDetailView）

週次一覧の「詳細を見る」をタップすると表示されます。

#### 表示内容

1. **週の期間**: yyyy年M月d日〜d日
2. **週の総括**: summaryフィールドの全文
3. **印象的な出来事**: memorable_events配列（最大5件）

---

## 3️⃣ 月次レポート（Monthly Report）

### 概要

月次レポートでは、月ごとに生成された総括を表示します。

### 表示内容

#### 月次一覧

各月のカードに以下を表示：
- **期間**: yyyy年M月
- **月の総括**: summaryフィールドの要約
- **印象的イベント件数**: memorable_eventsの件数
- **詳細ボタン**: タップで詳細ページへ

---

### Monthly詳細ページ（MonthlyDetailView）

月次一覧の「詳細を見る」をタップすると表示されます。

#### 表示内容

1. **月の期間**: yyyy年M月
2. **月の総括**: summaryフィールドの全文
3. **印象的な出来事**: memorable_events配列（最大5件）

---

## 🔄 ナビゲーション

### ホーム画面からのアクセス

ホーム画面（SimpleDashboardView）では、以下のカードから詳細ページにアクセスできます：

1. **今日のサマリーカード**
   - 「詳細を見る」ボタン → DailyDetailView

2. **Spotカード（録音1件）**
   - カードをタップ → SpotDetailView

### レポート画面からのアクセス

レポート画面（ReportView）では、以下のタブから詳細ページにアクセスできます：

1. **日次タブ**
   - 日次サマリーカードの「詳細を見る」ボタン → DailyDetailView
   - Spot一覧カードをタップ → SpotDetailView

2. **週次タブ**
   - 週次カードの「詳細を見る」ボタン → WeeklyDetailView

3. **月次タブ**
   - 月次カードの「詳細を見る」ボタン → MonthlyDetailView

---

## 📊 データソース

各分析レベルのデータソーステーブル：

| 分析レベル | テーブル名 | 主なカラム |
|----------|-----------|-----------|
| Spot | `spot_results` | device_id, recorded_at, vibe_score, summary, behavior, transcription |
| Daily | `daily_results` | device_id, local_date, vibe_score, summary, vibe_scores, burst_events |
| Weekly | `weekly_results` | device_id, week_start_date, summary, memorable_events |
| Monthly | `monthly_results` | device_id, month_start_date, summary, memorable_events |

---

## 🎨 デザイン

### カラースキーム

**気分スコア（vibe_score）の色分け**:
- **+30以上**: 緑（ポジティブ）
- **0〜+30**: 青（やや良い）
- **-30〜0**: オレンジ（やや悪い）
- **-30以下**: 赤（ネガティブ）

### グラフデザイン

**日次レポートのグラフ**:
- 背景: グレー（`Color(.systemGray6)`）
- グリッドライン: 50, 25, 0（太線）, -25, -50
- 棒グラフ: ポジティブ（緑）/ネガティブ（赤）/データなし（グレー）
- 右側目盛り: 数値表示

---

## 🚀 今後の拡張

### Phase 1: ✅ 完了（2025-12-01）

- [x] 日次レポートの完全実装
- [x] Daily詳細ページ（実データ）
- [x] Spot詳細ページ（実データ）
- [x] データ欠損の視覚化
- [x] 期間選択（7日/30日/90日）

### Phase 2: 🔜 次のステップ

- [ ] 週次レポートの完全実装（バックエンド準備中）
- [ ] 月次レポートの完全実装（バックエンド準備中）
- [ ] レポートタブで週次・月次タブを有効化

### Phase 3: 🔮 将来的な機能

- [ ] データエクスポート機能
- [ ] カスタム期間選択
- [ ] 比較機能（前週比、前月比など）
- [ ] グラフのインタラクティブ機能（ズーム、パン）

---

## 📝 用語の整理

### 重要な区別

**日次タブ ≠ Weekly分析**

- **日次タブ（1週間表示）**: 7日分のdaily_resultsを並べた一覧表示
- **Weekly分析**: 1週間全体をLLMで総括した1つのデータブロック

### データの関係性

```
Spot分析（録音1件）
  ↓ 集約
Daily分析（1日）
  ↓ 総括
Weekly分析（1週間）
  ↓ 総括
Monthly分析（1ヶ月）
```

---

---

## ⚡ パフォーマンス

### 90日分データ取得の性能

日次レポートでは最大90日分のデータを取得できますが、パフォーマンスへの影響は軽微です。

#### データサイズ見積もり

**1日あたりのデータサイズ**: 約5.5 KB
- vibe_score: 4 bytes
- summary: ~500 bytes
- vibe_scores (48個): ~1.5 KB
- burst_events (5個): ~1 KB
- profile_result: ~2 KB
- メタデータ: ~500 bytes

**90日分**: 5.5 KB × 90 = **約0.5 MB**

#### 取得時間

| 項目 | 時間 |
|------|------|
| DBクエリ | 50-200ms |
| ネットワーク転送（4G） | 約0.8秒 |
| ネットワーク転送（WiFi） | 約0.08秒 |
| デコード処理 | 100-300ms |
| **合計（4G）** | **約1-1.3秒** |
| **合計（WiFi）** | **約0.2-0.5秒** |

#### 結論

✅ **90日分のデータ取得は技術的に問題なく、ユーザー体験を損なわない速度で動作します。**

現在のアーキテクチャで十分なパフォーマンスが得られるため、特別な最適化（ページネーション、キャッシングなど）は不要です。

---

## 🔗 関連ドキュメント

- [技術仕様](../technical/TECHNICAL.md)
- [データベーススキーマ](../technical/DATABASE_SCHEMA.md)
