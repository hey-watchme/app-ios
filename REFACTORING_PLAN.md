# 🔄 データ取得リファクタリング計画

最終更新: 2025-11-16（セッション2完了）

---

## 📋 背景と目的

### 現状の問題
- ホーム画面（ダッシュボード）でデータが正しく表示されない
- RPC関数 `get_dashboard_data` が複雑すぎてデバッグ困難
- 複数回のアーキテクチャ変更によりコードがツギハギ状態

### リファクタリングの方針
**「ゼロベースで最適なものを作る」**

- 一旦すべてRPCを解除し、テーブルへ直接アクセス
- 動作を安定させてから、将来RPCで最適化

---

## 🏗️ データ構造の全体像

### アーキテクチャ

```
📝 録音（1回ごと）
  ↓
spot_results テーブル
  - 録音ごとの分析結果
  - vibe_score（気分スコア）
  - behavior（行動）
  - emotion（感情）
  - local_time（ローカルタイム） ← 最重要
  ↓
  1日分を自動集計
  ↓
daily_results テーブル
  - 1日の総合データ
  - average_vibe（平均気分スコア）
  - summary（LLMによるサマリー）
  - vibe_scores（時系列データ）
```

---

## 📱 画面とデータソースの対応

### ホーム画面（ダッシュボード） = 1日のサマリー

| カード | データソース | 現状 | 目標 |
|--------|-------------|------|------|
| **気分** | `daily_results` | ✅ 直接アクセス | ✅ 完了 |
| **行動** | `daily_results` | ❌ 古い`behavior_summary`使用 | 🚧 Phase 2で実装 |
| **感情** | `daily_results` | ❌ 古い`emotion_opensmile_summary`使用 | 🚧 Phase 2で実装 |

### 詳細画面

| 画面 | データソース | 現状 | 目標 |
|------|-------------|------|------|
| **気分詳細** | `spot_results` | ✅ 直接アクセス | ✅ 完了 |
| **行動詳細** | `spot_results` | 🚧 未実装（空白） | 🚧 Phase 2で実装 |
| **感情詳細** | `spot_results` | 🚧 未実装（空白） | 🚧 Phase 2で実装 |

---

## 🎯 Phase 1: 気分のみを完成させる

### ✅ 実装完了項目（2025-11-16）

1. **RPC解除とテーブル直接アクセス**
   - `SupabaseDataManager.fetchDailyResults()` 追加
   - `daily_results`テーブルへの直接アクセス実装
   - `spot_results`テーブルへの直接アクセス実装
   - 旧RPC関数は`@available(*, deprecated)`でマーク

2. **ローカルタイムの徹底**
   - すべての時刻表示を`local_time`カラムから取得
   - UTC時刻（`recorded_at`）へのフォールバックを削除
   - ユーザーの生活リズム（朝・昼・夜）を重視

3. **エラー処理の適正化**
   - `displayTime`を初期化時に1回だけ計算（キャッシュ化）
   - エラーログの重複を防止（48回 → 1回）
   - エラーは隠蔽せず明示的に表示

---

## 🛡️ エラー処理の哲学

### 基本原則

**「エラーは隠蔽せず、適切に処理する」**

#### ❌ 悪質なパターン（フォールバック）
```
local_timeがNULL → recorded_at（UTC）を使用 → ユーザーに間違った時刻を表示
```
→ バグを検出不可能にする悪質な隠蔽

#### ✅ 正しいパターン（明示的エラー）
```
local_timeがNULL → エラーログ出力 → ユーザーに"⚠️ ERROR"を表示
```
→ システムエラーを明確にし、修正可能にする

### エラーデータの扱い

#### 表示について
- **ユーザーに見せる**: ⭕ エラー表示は問題ない
- **システムログ**: ⭕ 1回だけ出力（重複防止）
- **データポイント**: ❌ グラフに含めると混乱を招く（次回修正）

#### 現在の問題（次回To-Do）
- エラーデータ（`local_time = NULL`）がグラフのデータポイントとして含まれる
- グラフが0時（00:00）にジャンプして表示される
- 折れ線グラフがUターンする不自然な挙動

---

## ⏰ ローカルタイムの重要性

### 設計思想

**「このアプリはユーザーの生活リズムを可視化するもの」**

- **朝・昼・夜**の区別が最重要
- UTC時刻は内部処理用（データベース管理）
- ユーザー体験には`local_time`のみを使用

### 実装ルール

1. **すべての時刻表示は`local_time`から取得**
2. **`recorded_at`（UTC）へのフォールバックは禁止**
3. **タイムゾーンはデバイスごとに保持**

### 修正した問題

- `DashboardTimeBlock.displayTime`が`recorded_at`（UTC）を使っていた
- パース失敗時にUTC時刻にフォールバックしていた
- 結果：ユーザーにUTC時刻が表示されていた（21:25が12:25と表示）

---

## 🔧 今回のセッションで修正した内容

### 1. データ取得の安定化
- ✅ `daily_results`テーブルへの直接アクセス実装
- ✅ `spot_results`テーブルへの直接アクセス実装
- ✅ タイムゾーン対応の確認

### 2. ローカルタイムの徹底
- ✅ `displayTime`の修正（ISO 8601対応）
- ✅ UTCフォールバックの削除
- ✅ ローカルタイム表示の確認（21:25が正しく表示）

### 3. エラー処理の適正化
- ✅ `displayTime`をcomputed property → stored propertyに変更
- ✅ 初期化時に1回だけ計算してキャッシュ
- ✅ エラーログの重複防止（48回 → 1回）

### 4. ソート順の確認
- ✅ `spot_results`を`local_time`でソート
- ✅ ユーザーの生活時間順に表示

---

## 📝 次回のTo-Do

### 優先度：高

1. **エラーデータのフィルタリング**
   - `local_time = NULL`のデータをグラフから除外
   - データポイントとして表示しない
   - リスト表示では"⚠️ ERROR"として表示（ユーザーに見せる）

2. **グラフのジャンプ問題の解決**
   - 0時にUターンする不自然な挙動を修正
   - エラーデータがグラフに含まれないようにする

### 優先度：中

3. **古いNULLデータの調査**
   - `recorded_at: 2025-11-15T15:59:13.121+00:00`のデータが`local_time = NULL`
   - システム移行前の古いデータか確認
   - 必要に応じてデータベース側で修正

4. **エラーログの改善**
   - エラー発生時により詳細な情報を出力
   - デバッグしやすいログフォーマットに統一

---

## ⚠️ 現在使っていないテーブル（削除予定）

以下のテーブルは古いアーキテクチャの名残：

- ❌ `behavior_summary` - Phase 2で`daily_results`に統合予定
- ❌ `emotion_opensmile_summary` - Phase 2で`daily_results`に統合予定

**Phase 1では、これらのデータは表示しない（空白表示）**

---

## 🚀 Phase 2: 行動・感情の実装（将来）

Phase 1（気分）が完成・安定したら着手

### 実装内容
1. `daily_results`に行動・感情の集計データを追加
2. Lambda側で集計処理を実装
3. ダッシュボードの行動・感情カードを`daily_results`から表示
4. 行動詳細・感情詳細を`spot_results`から表示

---

## 🔄 Phase 3: RPC再導入（将来）

すべて安定したら、パフォーマンス最適化としてRPCを再導入

### アーキテクチャ設計

データ取得レイヤーを抽象化し、直接アクセスとRPCを切り替え可能にする。

---

## ✅ Phase 1 完了状況（2025-11-16時点）

### 完了項目
- [x] ホーム画面の気分カードが`daily_results`から正しく表示される
- [x] 気分詳細画面が`spot_results`から正しく表示される
- [x] RPC関数を一切使用していない（Subject取得を除く）
- [x] ローカルタイムが正しく表示される
- [x] エラーログの重複を防止

### 残タスク（次回セッション）
- [ ] エラーデータをグラフから除外
- [ ] グラフのジャンプ問題を解決
- [ ] キャッシュの動作確認（日付スワイプ時）

---

## 📝 注意事項

### Git運用
- ブランチ: `refactor/direct-table-access`
- 動作確認後にmainにマージ

### テスト
- 実機での動作確認必須
- 複数日付でのデータ取得確認
- タイムゾーン違いでの動作確認

### ドキュメント更新
- README.mdの更新（Phase 1完了後）
- TECHNICAL.mdの更新（Phase 1完了後）

---

## 🎓 学んだこと

### エラー処理について
- **フォールバックは悪質なバグ隠蔽**：エラーを隠すのではなく明示する
- **エラーログは1回だけ**：不必要な重複を防ぐ
- **ユーザーにエラーを見せるのは問題ない**：システムの透明性を保つ

### ローカルタイムについて
- **ユーザーの生活リズムが最重要**：朝・昼・夜の区別
- **UTC時刻は内部処理用**：ユーザー体験には使わない
- **9時間のオフセットだけなら順序は変わらない**：ソート順に影響なし

### パフォーマンス最適化について
- **computed propertyの重複計算**：初期化時にキャッシュする
- **SwiftUIの再描画**：ビュー更新のたびに再計算される
- **1回の計算で済むものは1回だけ**：不必要な処理を防ぐ
