//
//  SimpleDashboardView.swift
//  ios_watchme_v9
//
//  „Ç∑„É≥„Éó„É´„Å™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÂÆüË£ÖÔºàÊó•‰ªò„Éê„Ç∞‰øÆÊ≠£ÁâàÔºâ
//

import SwiftUI

// „Éá„Éº„ÇøÂèñÂæó„ÅÆ„Éà„É™„Ç¨„Éº„ÇíÁÆ°ÁêÜ„Åô„ÇãÊßãÈÄ†‰Ωì
struct LoadDataTrigger: Equatable {
    let date: Date
    let deviceId: String?
}

struct SimpleDashboardView: View {
    let selectedDate: Date
    @EnvironmentObject var deviceManager: DeviceManager
    @EnvironmentObject var dataManager: SupabaseDataManager
    
    // ÂêÑ„Éá„Éº„Çø„ÇíÂÄãÂà•„Å´ÁÆ°ÁêÜÔºà„Ç∑„É≥„Éó„É´„Å´Ôºâ
    @State private var vibeReport: DailyVibeReport?
    @State private var behaviorReport: BehaviorReport?
    @State private var emotionReport: EmotionReport?
    @State private var subject: Subject?
    @State private var isLoading = false
    
    // „É¢„Éº„ÉÄ„É´Ë°®Á§∫ÁÆ°ÁêÜ
    @State private var showVibeSheet = false
    @State private var showBehaviorSheet = false
    @State private var showEmotionSheet = false
    
    var body: some View {
        ScrollView {
            VStack(spacing: 20) {
                if isLoading {
                    ProgressView("Ë™≠„ÅøËæº„Åø‰∏≠...")
                        .frame(maxWidth: .infinity, minHeight: 200)
                } else {
                    // ÂøÉÁêÜ„Ç∞„É©„Éï„Ç´„Éº„Éâ
                    vibeGraphCard
                        .padding(.horizontal, 20)
                    
                    // Ë°åÂãï„Ç∞„É©„Éï„Ç´„Éº„Éâ
                    behaviorGraphCard
                        .padding(.horizontal, 20)
                    
                    // ÊÑüÊÉÖ„Ç∞„É©„Éï„Ç´„Éº„Éâ
                    emotionGraphCard
                        .padding(.horizontal, 20)
                    
                    // Ë¶≥Ê∏¨ÂØæË±°„Ç´„Éº„Éâ
                    Group {
                        if let subject = subject {
                            observationTargetCard(subject)
                        } else {
                            noObservationTargetCard()
                        }
                    }
                    .padding(.horizontal, 20)
                    
                    Spacer(minLength: 100)
                }
            }
            .padding(.top, 20)
        }
        .background(
            Color.safeColor("BehaviorBackgroundPrimary")
                .ignoresSafeArea()
        )
        .task(id: LoadDataTrigger(date: selectedDate, deviceId: deviceManager.selectedDeviceID)) {
            // DeviceManager„ÅåreadyÁä∂ÊÖã„ÅÆÊôÇ„ÅÆ„Åø„Éá„Éº„ÇøÂèñÂæó„ÇíÂÆüË°å
            guard deviceManager.state == .ready else {
                print("‚ö†Ô∏è SimpleDashboardView: DeviceManager is not ready (state: \(deviceManager.state)), skipping data load")
                return
            }
            
            // Êó•‰ªò„Åæ„Åü„ÅØ„Éá„Éê„Ç§„ÇπID„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´ÂÆüË°å
            print("üìå SimpleDashboardView: .task triggered - date: \(selectedDate), deviceId: \(deviceManager.selectedDeviceID ?? "nil")")
            await loadAllData()
        }
        .onChange(of: deviceManager.state) { oldState, newState in
            // DeviceManager„Ååidle„ÇÑloading„Åã„Çâready„Å´Â§â„Çè„Å£„Åü„Å®„Åç„Å´„Éá„Éº„Çø„ÇíÂèñÂæó
            if oldState != .ready && newState == .ready {
                print("üéØ SimpleDashboardView: DeviceManager became ready, loading data")
                Task {
                    await loadAllData()
                }
            }
        }
        .onChange(of: deviceManager.selectedDeviceID) { oldDeviceId, newDeviceId in
            // „Éá„Éê„Ç§„Çπ„ÅåÂàá„ÇäÊõø„Çè„Å£„Åü„Å®„Åç„Å´„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
            if oldDeviceId != nil && newDeviceId != nil && oldDeviceId != newDeviceId {
                print("üîÑ SimpleDashboardView: Device changed from \(oldDeviceId!) to \(newDeviceId!), clearing data")
                clearAllData()
            }
        }
        .sheet(isPresented: $showVibeSheet) {
            NavigationView {
                HomeView(vibeReport: vibeReport, subject: subject)
                    .environmentObject(deviceManager)
                    .environmentObject(dataManager)
                    .navigationBarTitleDisplayMode(.large)
                    .navigationTitle("ÂøÉÁêÜ„Ç∞„É©„Éï")
                    .toolbar {
                        ToolbarItem(placement: .navigationBarLeading) {
                            Button("Èñâ„Åò„Çã") {
                                showVibeSheet = false
                            }
                        }
                    }
            }
        }
        .sheet(isPresented: $showBehaviorSheet) {
            NavigationView {
                BehaviorGraphView(behaviorReport: behaviorReport)
                    .environmentObject(deviceManager)
                    .environmentObject(dataManager)
                    .navigationBarTitleDisplayMode(.large)
                    .navigationTitle("Ë°åÂãï„Ç∞„É©„Éï")
                    .toolbar {
                        ToolbarItem(placement: .navigationBarLeading) {
                            Button("Èñâ„Åò„Çã") {
                                showBehaviorSheet = false
                            }
                        }
                    }
            }
        }
        .sheet(isPresented: $showEmotionSheet) {
            NavigationView {
                EmotionGraphView(emotionReport: emotionReport)
                    .environmentObject(deviceManager)
                    .environmentObject(dataManager)
                    .navigationBarTitleDisplayMode(.large)
                    .navigationTitle("ÊÑüÊÉÖ„Ç∞„É©„Éï")
                    .toolbar {
                        ToolbarItem(placement: .navigationBarLeading) {
                            Button("Èñâ„Åò„Çã") {
                                showEmotionSheet = false
                            }
                        }
                    }
            }
        }
    }
    
    // MARK: - View Components
    
    private var vibeGraphCard: some View {
        Group {
            if let vibeReport = vibeReport {
                ModernVibeCard(
                    vibeReport: vibeReport,
                    onNavigateToDetail: { }
                )
                .onTapGesture {
                    showVibeSheet = true
                }
            } else {
                UnifiedCard(
                    title: "Ê∞óÂàÜ",
                    navigationLabel: "ÂøÉÁêÜ„Ç∞„É©„Éï",
                    onNavigate: { }
                ) {
                    GraphEmptyStateView(
                        graphType: .vibe,
                        isDeviceLinked: !deviceManager.userDevices.isEmpty,
                        isCompact: true
                    )
                }
                .onTapGesture {
                    showVibeSheet = true
                }
            }
        }
    }
    
    private var behaviorGraphCard: some View {
        UnifiedCard(
            title: "Ë°åÂãï",
            navigationLabel: "Ë°åÂãï„Ç∞„É©„Éï",
            onNavigate: { }
        ) {
            if let behaviorReport = behaviorReport {
                VStack(spacing: 8) {
                    let filteredRanking = behaviorReport.summaryRanking.filter { 
                        $0.event.lowercased() != "other" && $0.event.lowercased() != "„Åù„ÅÆ‰ªñ" 
                    }
                    
                    if let topBehavior = filteredRanking.first {
                        VStack(spacing: 8) {
                            Text("üö∂")
                                .font(.system(size: 72))
                            
                            Text(topBehavior.event)
                                .font(.caption)
                                .foregroundStyle(Color.safeColor("PrimaryActionColor"))
                                .textCase(.uppercase)
                                .tracking(1.0)
                            
                            HStack(spacing: 4) {
                                Text("‰ªäÊó•„ÅÆ„É°„Ç§„É≥:")
                                    .font(.caption2)
                                    .foregroundStyle(Color.safeColor("BehaviorTextSecondary"))
                                
                                Text("\(topBehavior.count)Âõû")
                                    .font(.caption)
                                    .fontWeight(.semibold)
                                    .foregroundStyle(Color.safeColor("PrimaryActionColor").opacity(0.8))
                            }
                        }
                    }
                    
                    behaviorReportContent(behaviorReport)
                }
            } else {
                GraphEmptyStateView(
                    graphType: .behavior,
                    isDeviceLinked: !deviceManager.userDevices.isEmpty,
                    isCompact: true
                )
            }
        }
        .onTapGesture {
            showBehaviorSheet = true
        }
    }
    
    private var emotionGraphCard: some View {
        UnifiedCard(
            title: "ÊÑüÊÉÖ",
            navigationLabel: "ÊÑüÊÉÖ„Ç∞„É©„Éï",
            onNavigate: { }
        ) {
            if let emotionReport = emotionReport {
                emotionReportContent(emotionReport)
            } else {
                GraphEmptyStateView(
                    graphType: .emotion,
                    isDeviceLinked: !deviceManager.userDevices.isEmpty,
                    isCompact: true
                )
            }
        }
        .onTapGesture {
            showEmotionSheet = true
        }
    }
    
    private func observationTargetCard(_ subject: Subject) -> some View {
        ObservationTargetCard(
            title: "Ë¶≥Ê∏¨ÂØæË±°"
        ) {
            VStack(alignment: .leading, spacing: 12) {
                HStack(spacing: 16) {
                    // „Ç¢„Éê„Çø„Éº
                    if let avatarURL = subject.avatarUrl, !avatarURL.isEmpty {
                        AsyncImage(url: URL(string: avatarURL)) { image in
                            image
                                .resizable()
                                .aspectRatio(contentMode: .fill)
                                .frame(width: 60, height: 60)
                                .clipShape(Circle())
                                .overlay(
                                    Circle()
                                        .stroke(Color.white.opacity(0.3), lineWidth: 2)
                                )
                        } placeholder: {
                            Circle()
                                .fill(Color.white.opacity(0.2))
                                .frame(width: 60, height: 60)
                                .overlay(
                                    Image(systemName: "person.fill")
                                        .foregroundColor(.white.opacity(0.6))
                                )
                        }
                    } else {
                        Circle()
                            .fill(Color.white.opacity(0.2))
                            .frame(width: 60, height: 60)
                            .overlay(
                                Image(systemName: "person.fill")
                                    .foregroundColor(.white.opacity(0.6))
                            )
                    }
                    
                    // ÊÉÖÂ†±
                    VStack(alignment: .leading, spacing: 4) {
                        Text(subject.name ?? "ÂêçÂâçÊú™Ë®≠ÂÆö")
                            .font(.headline)
                            .foregroundColor(.white)
                        
                        HStack(spacing: 12) {
                            if let age = subject.age {
                                Label("\(age)Ê≠≥", systemImage: "calendar")
                                    .font(.caption)
                                    .foregroundColor(.white.opacity(0.8))
                            }
                            
                            if let gender = subject.gender {
                                Label(gender, systemImage: "person")
                                    .font(.caption)
                                    .foregroundColor(.white.opacity(0.8))
                            }
                        }
                    }
                    
                    Spacer()
                }
            }
            .padding(.vertical, 4)
        }
    }
    
    private func noObservationTargetCard() -> some View {
        ObservationTargetCard(
            title: "Ë¶≥Ê∏¨ÂØæË±°"
        ) {
            VStack(spacing: 12) {
                Image(systemName: "person.crop.circle.badge.questionmark")
                    .font(.system(size: 48))
                    .foregroundColor(.white.opacity(0.7))
                
                Text("Ë¶≥Ê∏¨ÂØæË±°„ÅåÊú™Ë®≠ÂÆö„Åß„Åô")
                    .font(.subheadline)
                    .foregroundColor(.white.opacity(0.9))
            }
            .frame(maxWidth: .infinity)
            .padding(.vertical, 8)
        }
    }
    
    private func behaviorReportContent(_ report: BehaviorReport) -> some View {
        VStack(alignment: .leading, spacing: 12) {
            let filteredRanking = report.summaryRanking.filter {
                $0.event.lowercased() != "other" && $0.event.lowercased() != "„Åù„ÅÆ‰ªñ"
            }
            
            if filteredRanking.count > 1 {
                VStack(alignment: .leading, spacing: 10) {
                    ForEach(Array(filteredRanking.prefix(3).enumerated()), id: \.element.id) { index, behavior in
                        HStack(spacing: 8) {
                            Text("\(index + 1)")
                                .font(.caption)
                                .fontWeight(.medium)
                                .foregroundStyle(Color.safeColor("BehaviorTextSecondary"))
                                .frame(width: 20, alignment: .leading)
                            
                            Text(behavior.event)
                                .font(.subheadline)
                                .foregroundStyle(Color.safeColor("BehaviorTextPrimary"))
                                .lineLimit(1)
                            
                            Spacer()
                            
                            Text("\(behavior.count)")
                                .font(.caption)
                                .foregroundStyle(Color.safeColor("BehaviorTextTertiary"))
                        }
                    }
                }
                .padding()
                .background(Color.safeColor("CardBackground"))
                .cornerRadius(8)
            }
        }
    }
    
    private func emotionReportContent(_ report: EmotionReport) -> some View {
        VStack(spacing: 16) {
            if !report.emotionGraph.isEmpty {
                // ÂÖ®ÊôÇÈñì„ÅÆÊÑüÊÉÖ„ÅÆÂπ≥Âùá„ÇíË®àÁÆó
                let avgJoy = report.emotionGraph.map { $0.joy }.reduce(0, +) / report.emotionGraph.count
                let avgTrust = report.emotionGraph.map { $0.trust }.reduce(0, +) / report.emotionGraph.count
                let avgFear = report.emotionGraph.map { $0.fear }.reduce(0, +) / report.emotionGraph.count
                let avgSurprise = report.emotionGraph.map { $0.surprise }.reduce(0, +) / report.emotionGraph.count
                let avgSadness = report.emotionGraph.map { $0.sadness }.reduce(0, +) / report.emotionGraph.count
                let avgDisgust = report.emotionGraph.map { $0.disgust }.reduce(0, +) / report.emotionGraph.count
                let avgAnger = report.emotionGraph.map { $0.anger }.reduce(0, +) / report.emotionGraph.count
                let avgAnticipation = report.emotionGraph.map { $0.anticipation }.reduce(0, +) / report.emotionGraph.count
                
                let emotions = [
                    ("joy", avgJoy, "üòä", Color.safeColor("EmotionJoy")),
                    ("trust", avgTrust, "ü§ù", Color.safeColor("EmotionTrust")),
                    ("fear", avgFear, "üò®", Color.safeColor("EmotionFear")),
                    ("surprise", avgSurprise, "üò≤", Color.safeColor("EmotionSurprise")),
                    ("sadness", avgSadness, "üò¢", Color.safeColor("EmotionSadness")),
                    ("disgust", avgDisgust, "ü§¢", Color.safeColor("EmotionDisgust")),
                    ("anger", avgAnger, "üò†", Color.safeColor("EmotionAnger")),
                    ("anticipation", avgAnticipation, "üéØ", Color.safeColor("EmotionAnticipation"))
                ]
                
                let topEmotions = emotions.sorted { $0.1 > $1.1 }.prefix(3)
                
                // „Éà„ÉÉ„ÉóÊÑüÊÉÖ„ÇíÁµµÊñáÂ≠ó„ÅßË°®Á§∫
                HStack(spacing: 16) {
                    ForEach(Array(topEmotions.enumerated()), id: \.element.0) { index, emotion in
                        VStack(spacing: 4) {
                            Text(emotion.2)
                                .font(.system(size: 36))
                            
                            Text("\(emotion.1)%")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                    }
                }
                
                // ÊÑüÊÉÖ„Éê„Éº
                VStack(alignment: .leading, spacing: 8) {
                    ForEach(Array(topEmotions.enumerated()), id: \.element.0) { index, emotion in
                        HStack {
                            Text(emotionLabel(for: emotion.0))
                                .font(.caption)
                                .frame(width: 80, alignment: .leading)
                            
                            GeometryReader { geometry in
                                ZStack(alignment: .leading) {
                                    Rectangle()
                                        .fill(Color.safeColor("BorderLight").opacity(0.2))
                                        .frame(height: 6)
                                        .cornerRadius(3)
                                    
                                    Rectangle()
                                        .fill(emotion.3)
                                        .frame(width: geometry.size.width * CGFloat(emotion.1) / 100, height: 6)
                                        .cornerRadius(3)
                                }
                            }
                            .frame(height: 6)
                        }
                    }
                }
                .padding()
                .background(Color.safeColor("CardBackground"))
                .cornerRadius(8)
            }
        }
    }
    
    private func emotionLabel(for key: String) -> String {
        switch key.lowercased() {
        case "joy": return "Âñú„Å≥"
        case "trust": return "‰ø°È†º"
        case "fear": return "ÊÅê„Çå"
        case "surprise": return "È©ö„Åç"
        case "sadness": return "ÊÇ≤„Åó„Åø"
        case "disgust": return "Â´åÊÇ™"
        case "anger": return "ÊÄí„Çä"
        case "anticipation": return "ÊúüÂæÖ"
        default: return key
        }
    }
    
    private func clearAllData() {
        print("üßπ SimpleDashboardView: Clearing all data")
        vibeReport = nil
        behaviorReport = nil
        emotionReport = nil
        subject = nil
    }
    
    private func loadAllData() async {
        print("üîÑ SimpleDashboardView: loadAllData() called.")
        print("   - selectedDeviceID: \(deviceManager.selectedDeviceID ?? "nil")")
        print("   - localDeviceIdentifier: \(deviceManager.localDeviceIdentifier ?? "nil")")
        
        guard let deviceId = deviceManager.selectedDeviceID ?? deviceManager.localDeviceIdentifier else {
            print("‚ùå SimpleDashboardView: loadAllData() - deviceId is nil. Clearing data.")
            print("   - selectedDeviceID was: \(deviceManager.selectedDeviceID ?? "nil")")
            print("   - localDeviceIdentifier was: \(deviceManager.localDeviceIdentifier ?? "nil")")
            // „Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
            await MainActor.run {
                self.vibeReport = nil
                self.behaviorReport = nil
                self.emotionReport = nil
                self.subject = nil
            }
            return
        }
        
        print("‚úÖ SimpleDashboardView: loadAllData() - deviceId is \(deviceId). Proceeding to fetch data.")
        
        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
        print("üîç SimpleDashboardView loading data")
        print("   üì± Device ID: \(deviceId)")
        print("   üìÖ Selected Date: \(selectedDate)")
        print("   üåç Timezone: \(deviceManager.getTimezone(for: deviceId))")
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã
        await MainActor.run {
            isLoading = true
        }
        
        defer {
            Task { @MainActor in
                isLoading = false
            }
        }
        
        // „Éá„Éº„ÇøÂèñÂæó
        let timezone = deviceManager.getTimezone(for: deviceId)
        let result = await dataManager.fetchAllReports(
            deviceId: deviceId,
            date: selectedDate,
            timezone: timezone
        )
        
        // ÂèñÂæó„Åó„Åü„Éá„Éº„Çø„ÇíË®≠ÂÆö
        await MainActor.run {
            self.vibeReport = result.vibeReport
            self.behaviorReport = result.behaviorReport
            self.emotionReport = result.emotionReport
            self.subject = result.subject
        }
        
        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ - ÂèñÂæóÁµêÊûú
        print("‚úÖ SimpleDashboardView data loaded:")
        print("   - Vibe: \(result.vibeReport != nil ? "‚úì" : "‚úó")")
        print("   - Behavior: \(result.behaviorReport != nil ? "‚úì" : "‚úó")")
        print("   - Emotion: \(result.emotionReport != nil ? "‚úì" : "‚úó")")
        print("   - Subject: \(result.subject != nil ? "‚úì" : "‚úó")")
        
        if let vibe = result.vibeReport {
            print("   üìä Vibe date: \(vibe.date), average: \(vibe.averageScore)")
        }
    }
}